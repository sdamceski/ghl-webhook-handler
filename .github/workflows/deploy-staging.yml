name: Deploy GHL webhook listener (staging)

on:
  push:
    branches:
      - staging

jobs:
  deploy-staging:
    name: Deploy Lambda via SAM (staging)
    runs-on: [self-hosted, staging]

    permissions:
      id-token: write
      contents: read

    env:
      AWS_REGION: us-east-2

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials (staging)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_STAGING_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build with SAM
        run: sam build

      - name: Update Lambda code (staging)
        run: |
          python3 - <<'PY'
          import os
          import shutil
          import zipfile

          build_dir = ".aws-sam/build/GhlWebhookListenerFunction"
          zip_path = "/tmp/ghl-webhook-events-staging.zip"

          if os.path.exists(zip_path):
              os.remove(zip_path)

          with zipfile.ZipFile(zip_path, "w", zipfile.ZIP_DEFLATED) as zf:
              for root, dirs, files in os.walk(build_dir):
                  for name in files:
                      full_path = os.path.join(root, name)
                      rel_path = os.path.relpath(full_path, build_dir)
                      zf.write(full_path, rel_path)

          print(f"Created {zip_path}")
          PY

          aws lambda update-function-code \
            --function-name ghl-webhook-events-staging \
            --zip-file fileb:///tmp/ghl-webhook-events-staging.zip
